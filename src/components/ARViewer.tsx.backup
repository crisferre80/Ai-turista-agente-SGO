'use client';

/**
 * Componente principal de Realidad Aumentada con interfaz intuitiva y profesional
 * Incluye tutorial de introducción, diseño moderno y experiencia guiada para turistas
 */

import React, { useEffect, useRef, useState } from 'react';
import { createPortal } from 'react-dom';
import { Canvas } from '@react-three/fiber';
import { X, Loader2, AlertTriangle, Maximize2, Camera, Eye, Hand, RotateCcw, Play, CheckCircle } from 'lucide-react';
import type { ARViewerProps, WebXRCapabilities, ARLoadingState } from '@/types/ar';
import { detectWebXRCapabilities, meetsARRequirements, isMobileDevice } from '@/lib/webxr';
import ARScene from './ARScene';

export default function ARViewer({ attraction, onClose, onError }: ARViewerProps) {
  const [capabilities, setCapabilities] = useState<WebXRCapabilities | null>(null);
  const [loadingState, setLoadingState] = useState<ARLoadingState>({
    isLoading: true,
    progress: 0,
  });
  const [error, setError] = useState<string | null>(null);
  const [isFullscreen, setIsFullscreen] = useState(false);
  const [cameraError, setCameraError] = useState<string | null>(null);
  const [canPortal, setCanPortal] = useState(false);
  const [isPlaced, setIsPlaced] = useState(false);
  const [showTutorial, setShowTutorial] = useState(true);
  const [tutorialStep, setTutorialStep] = useState(0);
  const [hasCameraPermission, setHasCameraPermission] = useState(false);
  const containerRef = useRef<HTMLDivElement>(null);
  const videoRef = useRef<HTMLVideoElement | null>(null);
  const streamRef = useRef<MediaStream | null>(null);

  useEffect(() => {
    initializeAR();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  // Habilitar portal una vez montado en cliente
  useEffect(() => {
    setCanPortal(true);
  }, []);

  // Detener cámara al desmontar el componente
  useEffect(() => {
    return () => {
      if (streamRef.current) {
        streamRef.current.getTracks().forEach(track => track.stop());
        streamRef.current = null;
      }
    };
  }, []);

  const initializeAR = async () => {
    try {
      setLoadingState({ isLoading: true, progress: 20, currentAsset: 'Preparando experiencia AR...' });

      // Verificar capacidades WebXR
      const caps = await detectWebXRCapabilities();
      setCapabilities(caps);

      setLoadingState({ isLoading: true, progress: 50, currentAsset: 'Verificando compatibilidad...' });

      // Verificar requisitos mínimos
      const requirements = await meetsARRequirements();

      if (!requirements.meets) {
        throw new Error(
          `Tu dispositivo no es compatible con Realidad Aumentada. ${requirements.missing.join(', ')}`
        );
      }

      if (!caps.isSupported) {
        throw new Error(
          'Realidad Aumentada no está disponible en este navegador. ' +
          'Te recomendamos usar Chrome, Safari o Edge en un dispositivo móvil.'
        );
      }

      setLoadingState({ isLoading: true, progress: 70, currentAsset: 'Configurando cámara...' });

      // Solicitar permisos de cámara de manera más amigable
      if (typeof navigator !== 'undefined' && navigator.mediaDevices?.getUserMedia) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' },
            audio: false,
          });
          streamRef.current = stream;
          setHasCameraPermission(true);

          if (videoRef.current) {
            videoRef.current.srcObject = stream;
            await videoRef.current.play().catch(() => {
              // El usuario verá la imagen cuando interactúe
            });
          }
        } catch (cameraError) {
          console.warn('Permisos de cámara denegados:', cameraError);
          setCameraError('Para una mejor experiencia, permite el acceso a la cámara.');
          // Continuamos sin cámara - el usuario puede usar AR en pantalla
        }
      }

      setLoadingState({ isLoading: true, progress: 90, currentAsset: 'Cargando contenido...' });

      // Simular carga de recursos
      await new Promise(resolve => setTimeout(resolve, 500));

      setLoadingState({ isLoading: false, progress: 100 });
    } catch (err) {
      console.error('Error al inicializar AR:', err);
      const errorMessage = err instanceof Error ? err.message : 'Error desconocido al iniciar Realidad Aumentada';
      setError(errorMessage);

      if (onError) {
        onError(err instanceof Error ? err : new Error(errorMessage));
      }
    }
  };

  const toggleFullscreen = async () => {
    if (!containerRef.current) return;

    try {
      if (!isFullscreen) {
        await containerRef.current.requestFullscreen();
        setIsFullscreen(true);
      } else {
        await document.exitFullscreen();
        setIsFullscreen(false);
      }
    } catch (err) {
      console.error('Error al cambiar pantalla completa:', err);
    }
  };

  const handleClose = () => {
    if (streamRef.current) {
      streamRef.current.getTracks().forEach(track => track.stop());
      streamRef.current = null;
    }
    if (isFullscreen) {
      document.exitFullscreen().catch(() => {});
    }
    onClose();
  };

  const startExperience = () => {
    setShowTutorial(false);
  };

  const nextTutorialStep = () => {
    if (tutorialStep < 2) {
      setTutorialStep(tutorialStep + 1);
    } else {
      startExperience();
    }
  };

  const prevTutorialStep = () => {
    if (tutorialStep > 0) {
      setTutorialStep(tutorialStep - 1);
    }
  };

  // Primer toque en la escena: considerar que el usuario "pegó" la escena al entorno
  const handleScenePointerDown = () => {
    if (!isPlaced) {
      setIsPlaced(true);
    }
  };

  // Renderizar pantalla de carga
  if (loadingState.isLoading) {
    return (
      <div className="fixed inset-0 z-50 bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 flex items-center justify-center">
        <div className="text-center text-white max-w-sm mx-4">
          <div className="relative mb-8">
            <div className="w-20 h-20 bg-white/10 backdrop-blur-md rounded-2xl flex items-center justify-center mx-auto mb-4">
              <Eye className="h-10 w-10 text-blue-300" />
            </div>
            <div className="absolute -top-2 -right-2 w-6 h-6 bg-green-400 rounded-full animate-pulse" />
          </div>

          <h2 className="text-2xl font-bold mb-2 bg-gradient-to-r from-blue-300 to-purple-300 bg-clip-text text-transparent">
            Descubriendo {attraction.name}
          </h2>
          <p className="text-blue-200 mb-6 text-sm">{loadingState.currentAsset}</p>

          <div className="w-full h-2 bg-white/20 rounded-full overflow-hidden mb-4">
            <div
              className="h-full bg-gradient-to-r from-blue-400 to-purple-400 transition-all duration-500 ease-out rounded-full"
              style={{ width: `${loadingState.progress}%` }}
            />
          </div>

          <p className="text-xs text-blue-300">
            Preparando experiencia de Realidad Aumentada...
          </p>
        </div>
      </div>
    );
  }

  // Renderizar tutorial de introducción
  if (showTutorial) {
    const tutorialSteps = [
      {
        icon: <Camera className="h-12 w-12 text-blue-400" />,
        title: "Bienvenido a AR",
        description: "Descubre " + attraction.name + " de una manera completamente nueva con Realidad Aumentada.",
        detail: "Verás información, modelos 3D y contenido multimedia superpuestos en el mundo real."
      },
      {
        icon: <Hand className="h-12 w-12 text-purple-400" />,
        title: "Interacción Intuitiva",
        description: "Toca, pellizca y mueve tu dispositivo para explorar.",
        detail: "Coloca contenido en tu entorno y descubre detalles ocultos tocando los elementos flotantes."
      },
      {
        icon: <Eye className="h-12 w-12 text-green-400" />,
        title: "Experiencia Inmersiva",
        description: "Mira a través de tu cámara para ver el contenido AR.",
        detail: hasCameraPermission
          ? "Tu cámara está lista. Apunta a un espacio plano para comenzar."
          : "Permite el acceso a la cámara para la mejor experiencia."
      }
    ];

    const currentStep = tutorialSteps[tutorialStep];

    return (
      <div className="fixed inset-0 z-50 bg-gradient-to-br from-blue-600 via-purple-600 to-indigo-700 flex items-center justify-center p-4">
        <div className="bg-white/10 backdrop-blur-xl border border-white/20 rounded-3xl p-8 max-w-md w-full">
          <div className="text-center">
            {/* Indicadores de paso */}
            <div className="flex justify-center gap-2 mb-8">
              {tutorialSteps.map((_, index) => (
                <div
                  key={index}
                  className={`w-2 h-2 rounded-full transition-all duration-300 ${
                    index === tutorialStep ? 'bg-white scale-125' : 'bg-white/40'
                  }`}
                />
              ))}
            </div>

            {/* Icono del paso actual */}
            <div className="w-20 h-20 bg-white/10 rounded-2xl flex items-center justify-center mx-auto mb-6">
              {currentStep.icon}
            </div>

            {/* Contenido del paso */}
            <h2 className="text-2xl font-bold text-white mb-3">{currentStep.title}</h2>
            <p className="text-blue-100 mb-4 text-sm leading-relaxed">{currentStep.description}</p>
            <p className="text-blue-200 mb-8 text-xs leading-relaxed">{currentStep.detail}</p>

            {/* Botones de navegación */}
            <div className="flex gap-3">
              {tutorialStep > 0 && (
                <button
                  onClick={prevTutorialStep}
                  className="flex-1 bg-white/10 text-white px-6 py-3 rounded-xl font-semibold hover:bg-white/20 transition-all duration-200"
                >
                  Anterior
                </button>
              )}

              <button
                onClick={nextTutorialStep}
                className="flex-1 bg-white text-blue-600 px-6 py-3 rounded-xl font-semibold hover:bg-blue-50 transition-all duration-200 transform hover:scale-105"
              >
                {tutorialStep === tutorialSteps.length - 1 ? 'Comenzar' : 'Siguiente'}
              </button>
            </div>

            {/* Botón de saltar */}
            <button
              onClick={startExperience}
              className="mt-4 text-blue-200 text-sm hover:text-white transition-colors"
            >
              Saltar tutorial
            </button>
          </div>
        </div>
      </div>
    );
  }
    return (
      <div className="fixed inset-0 z-50 bg-gradient-to-br from-red-900 via-pink-900 to-purple-900 flex items-center justify-center p-4">
        <div className="bg-white/10 backdrop-blur-lg border border-white/20 rounded-2xl p-8 max-w-md w-full">
          <div className="text-center">
            <div className="w-16 h-16 bg-red-500/20 rounded-2xl flex items-center justify-center mx-auto mb-4">
              <AlertTriangle className="h-8 w-8 text-red-300" />
            </div>

            <h2 className="text-xl font-bold text-white mb-3">No se pudo iniciar AR</h2>
            <p className="text-gray-200 mb-6 text-sm leading-relaxed">{error}</p>

            <div className="bg-white/5 rounded-xl p-4 mb-6">
              <h3 className="text-white font-semibold mb-3 text-sm">Para usar Realidad Aumentada:</h3>
              <div className="space-y-2 text-xs text-gray-300">
                <div className="flex items-center gap-2">
                  <CheckCircle className="h-4 w-4 text-green-400" />
                  <span>Usa Chrome, Safari o Edge</span>
                </div>
                <div className="flex items-center gap-2">
                  <CheckCircle className="h-4 w-4 text-green-400" />
                  <span>Activa permisos de cámara</span>
                </div>
                <div className="flex items-center gap-2">
                  <CheckCircle className="h-4 w-4 text-green-400" />
                  <span>Dispositivo con sensores de movimiento</span>
                </div>
              </div>
            </div>

            <button
              onClick={handleClose}
              className="w-full bg-white text-red-600 px-6 py-3 rounded-xl font-semibold hover:bg-gray-100 transition-all duration-200 transform hover:scale-105"
            >
              Entendido
            </button>
          </div>
        </div>
      </div>
    );
  }

  // Contenido principal de la escena AR
  const content = React.createElement('div', {
    ref: containerRef,
    className: 'fixed inset-0 z-50 bg-black overflow-hidden'
  },
    // Fondo de cámara
    React.createElement('video', {
      ref: videoRef,
      className: 'absolute inset-0 w-full h-full object-cover',
      autoPlay: true,
      muted: true,
      playsInline: true
    }),

    // Header
    React.createElement('div', {
      className: 'absolute top-0 left-0 right-0 z-10 bg-gradient-to-b from-black/60 via-black/40 to-transparent'
    },
      React.createElement('div', {
        className: 'flex items-center justify-between p-6'
      },
        React.createElement('div', { className: 'text-white' },
          React.createElement('h2', { className: 'text-lg font-bold' }, attraction.name),
          React.createElement('p', { className: 'text-sm text-blue-200' }, 'Realidad Aumentada')
        ),
        React.createElement('div', { className: 'flex gap-2' },
          React.createElement('button', {
            onClick: toggleFullscreen,
            className: 'text-white hover:bg-white/20 rounded-full p-3 transition-all duration-200 hover:scale-110',
            'aria-label': 'Pantalla completa'
          }, React.createElement(Maximize2, { className: 'h-5 w-5' })),
          React.createElement('button', {
            onClick: handleClose,
            className: 'text-white hover:bg-red-500/20 rounded-full p-3 transition-all duration-200 hover:scale-110',
            'aria-label': 'Cerrar AR'
          }, React.createElement(X, { className: 'h-5 w-5' }))
        )
      )
    ),

    // Canvas 3D
    React.createElement(Canvas, {
      camera: { position: [0, 1.6, 3], fov: 75 },
      gl: { alpha: true },
      style: { background: 'transparent' },
      onPointerDown: handleScenePointerDown
    },
      React.createElement(ARScene, {
        attraction: attraction,
        capabilities: capabilities,
        showGrid: !isPlaced,
        disableOrbitControls: isPlaced && isMobileDevice()
      })
    ),

    // Controles
    React.createElement('div', {
      className: 'absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 via-black/60 to-transparent p-6'
    },
      React.createElement('div', { className: 'max-w-md mx-auto' },
        // Estado AR
        React.createElement('div', { className: 'flex items-center justify-center gap-3 text-white mb-4' },
          React.createElement('div', {
            className: `w-3 h-3 rounded-full ${hasCameraPermission ? 'bg-green-400' : 'bg-yellow-400'} animate-pulse`
          }),
          React.createElement('span', { className: 'text-sm font-medium' },
            hasCameraPermission ? 'AR con Cámara' : 'AR en Pantalla'
          ),
          capabilities?.arMode === 'immersive-ar' && React.createElement('span', {
            className: 'text-xs bg-purple-500/20 text-purple-200 px-2 py-1 rounded-full'
          }, 'Inmersivo')
        ),

        // Guía
        React.createElement('div', { className: 'bg-white/10 backdrop-blur-md rounded-2xl p-4 text-white' },
          !isPlaced ? 
            React.createElement('div', { className: 'text-center' },
              React.createElement(Hand, { className: 'h-8 w-8 text-blue-300 mx-auto mb-2' }),
              React.createElement('p', { className: 'font-semibold text-sm mb-1' }, 'Coloca el contenido'),
              React.createElement('p', { className: 'text-xs text-gray-300' }, `Toca la pantalla para posicionar ${attraction.name} en tu espacio`)
            ) :
            React.createElement('div', { className: 'grid grid-cols-2 gap-3 text-center' },
              React.createElement('div', null,
                React.createElement(RotateCcw, { className: 'h-6 w-6 text-green-300 mb-1 mx-auto' }),
                React.createElement('span', { className: 'text-xs text-gray-300' }, 'Mueve')
              ),
              React.createElement('div', null,
                React.createElement(Eye, { className: 'h-6 w-6 text-purple-300 mb-1 mx-auto' }),
                React.createElement('span', { className: 'text-xs text-gray-300' }, 'Explora')
              )
            )
        ),

        cameraError && React.createElement('div', {
          className: 'mt-4 bg-yellow-500/20 border border-yellow-500/30 text-yellow-200 text-xs rounded-xl px-4 py-3'
        },
          React.createElement('div', { className: 'flex items-center gap-2' },
            React.createElement(AlertTriangle, { className: 'h-4 w-4 flex-shrink-0' }),
            React.createElement('span', null, cameraError)
          )
        )
      )
    )

  // Renderizar escena AR (en portal a <body> para asegurar overlay global)
  if (canPortal && typeof document !== 'undefined') {
    return createPortal(content, document.body);
  }

  return content;
}
