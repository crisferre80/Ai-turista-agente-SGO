<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Auto-Promociones</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-section h2 {
            margin-top: 0;
            color: #ffd700;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: scale(1.05);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .result {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            color: #4ade80;
        }
        .error {
            color: #f87171;
        }
        .warning {
            color: #fbbf24;
        }
        .info {
            color: #60a5fa;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-success {
            background: #4ade80;
            color: black;
        }
        .status-error {
            background: #f87171;
            color: white;
        }
        .status-pending {
            background: #fbbf24;
            color: black;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test de Auto-Promociones</h1>
        
        <div class="test-section">
            <h2>1. Test de Scheduler <span id="scheduler-status" class="status-badge status-pending">PENDIENTE</span></h2>
            <p>Verifica si el scheduler encuentra promociones activas.</p>
            <button onclick="testScheduler()">‚ñ∂Ô∏è Probar Scheduler</button>
            <div id="scheduler-result" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>2. Test de API Auto-Promotion <span id="api-status" class="status-badge status-pending">PENDIENTE</span></h2>
            <p>Verifica si la API retorna una promoci√≥n lista para ejecutar.</p>
            <button onclick="testAutoPromotionAPI()">‚ñ∂Ô∏è Probar API</button>
            <div id="api-result" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>3. Ver Todas las Promociones <span id="list-status" class="status-badge status-pending">PENDIENTE</span></h2>
            <p>Lista todas las promociones en la base de datos.</p>
            <button onclick="listPromotions()">‚ñ∂Ô∏è Listar Promociones</button>
            <div id="list-result" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>4. Test de Frecuencia <span id="frequency-status" class="status-badge status-pending">PENDIENTE</span></h2>
            <p>Simula el c√°lculo de frecuencia para ver si la promoci√≥n deber√≠a ejecutarse.</p>
            <button onclick="testFrequency()">‚ñ∂Ô∏è Calcular Frecuencia</button>
            <div id="frequency-result" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>5. Reset Last Executed <span id="reset-status" class="status-badge status-pending">PENDIENTE</span></h2>
            <p>Resetea el campo last_executed para forzar que la promoci√≥n se ejecute.</p>
            <input type="text" id="promo-id" placeholder="ID de la promoci√≥n" style="width: 300px; padding: 8px; border-radius: 4px; border: none; margin-right: 10px;">
            <button onclick="resetLastExecuted()">üîÑ Reset</button>
            <div id="reset-result" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h2>6. Test Completo <span id="full-status" class="status-badge status-pending">PENDIENTE</span></h2>
            <p>Ejecuta todos los tests en secuencia.</p>
            <button onclick="runFullTest()">üöÄ Ejecutar Test Completo</button>
            <div id="full-result" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        const BASE_URL = window.location.origin;

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${type}`;
            element.innerHTML = content;
        }

        function updateStatus(statusId, status) {
            const element = document.getElementById(statusId);
            element.className = `status-badge status-${status}`;
            element.textContent = status === 'success' ? '‚úÖ OK' : status === 'error' ? '‚ùå ERROR' : '‚è≥ PENDIENTE';
        }

        async function testScheduler() {
            showResult('scheduler-result', '‚è≥ Consultando scheduler...', 'info');
            updateStatus('scheduler-status', 'pending');

            try {
                const response = await fetch(`${BASE_URL}/api/admin/auto-promotions/scheduler`);
                const data = await response.json();

                let output = `Estado: ${response.status}\n\n`;
                output += `‚úÖ Success: ${data.success}\n`;
                output += `üìä Promociones encontradas: ${data.count}\n`;
                output += `üïê Hora actual: ${data.current_time}\n`;
                output += `üìÖ D√≠a actual: ${data.current_day}\n\n`;

                if (data.count > 0) {
                    output += `üéØ PROMOCIONES LISTAS PARA EJECUTAR:\n\n`;
                    data.promotions.forEach((promo, idx) => {
                        output += `${idx + 1}. ${promo.title}\n`;
                        output += `   ID: ${promo.id}\n`;
                        output += `   Negocio: ${promo.business_name}\n`;
                        output += `   Frecuencia: ${promo.frequency_type} (${promo.frequency_value})\n`;
                        output += `   Horario: ${promo.start_time} - ${promo.end_time}\n`;
                        output += `   D√≠as: ${promo.days_of_week}\n`;
                        output += `   √öltima ejecuci√≥n: ${promo.last_executed || 'Nunca'}\n`;
                        output += `   Prioridad: ${promo.priority}\n\n`;
                    });
                    updateStatus('scheduler-status', 'success');
                } else {
                    output += `‚ö†Ô∏è No hay promociones listas para ejecutar.\n`;
                    output += `\nPosibles razones:\n`;
                    output += `- No hay promociones activas\n`;
                    output += `- Las promociones no cumplen los criterios de horario\n`;
                    output += `- Las promociones no cumplen los criterios de frecuencia\n`;
                    output += `- Las promociones no est√°n configuradas para el d√≠a actual\n`;
                    updateStatus('scheduler-status', 'error');
                }

                showResult('scheduler-result', output, data.count > 0 ? 'success' : 'warning');
            } catch (error) {
                showResult('scheduler-result', `‚ùå ERROR: ${error.message}`, 'error');
                updateStatus('scheduler-status', 'error');
            }
        }

        async function testAutoPromotionAPI() {
            showResult('api-result', '‚è≥ Consultando API...', 'info');
            updateStatus('api-status', 'pending');

            try {
                const response = await fetch(`${BASE_URL}/api/auto-promotion`);
                const data = await response.json();

                let output = `Estado: ${response.status}\n\n`;
                output += `‚úÖ Should Show: ${data.shouldShow}\n\n`;

                if (data.shouldShow && data.promotion) {
                    output += `üéØ PROMOCI√ìN RETORNADA:\n\n`;
                    output += `T√≠tulo: ${data.promotion.title}\n`;
                    output += `Negocio: ${data.promotion.business_name}\n`;
                    output += `Mensaje: ${data.promotion.message}\n`;
                    output += `Prioridad: ${data.promotion.priority}\n\n`;
                    
                    if (data.metadata) {
                        output += `üìä METADATA:\n`;
                        output += `Total programadas: ${data.metadata.total_promotions_scheduled}\n`;
                        output += `Hora actual: ${data.metadata.current_time}\n`;
                        output += `Timestamp: ${data.metadata.timestamp}\n`;
                    }
                    
                    updateStatus('api-status', 'success');
                    showResult('api-result', output, 'success');
                } else {
                    output += `‚ö†Ô∏è No hay promociones para mostrar en este momento.\n\n`;
                    output += `Esto es normal si:\n`;
                    output += `- La promoci√≥n ya se ejecut√≥ recientemente\n`;
                    output += `- No es el horario configurado\n`;
                    output += `- No es el d√≠a configurado\n`;
                    
                    updateStatus('api-status', 'warning');
                    showResult('api-result', output, 'warning');
                }
            } catch (error) {
                showResult('api-result', `‚ùå ERROR: ${error.message}`, 'error');
                updateStatus('api-status', 'error');
            }
        }

        async function listPromotions() {
            showResult('list-result', '‚è≥ Obteniendo promociones...', 'info');
            updateStatus('list-status', 'pending');

            try {
                const response = await fetch(`${BASE_URL}/api/admin/auto-promotions`);
                const data = await response.json();

                let output = `Total de promociones: ${data.promotions?.length || 0}\n\n`;

                if (data.promotions && data.promotions.length > 0) {
                    data.promotions.forEach((promo, idx) => {
                        output += `${idx + 1}. ${promo.title}\n`;
                        output += `   ID: ${promo.id}\n`;
                        output += `   Estado: ${promo.is_active ? '‚úÖ ACTIVA' : '‚ùå INACTIVA'}\n`;
                        output += `   Negocio: ${promo.business_name}\n`;
                        output += `   Frecuencia: ${promo.frequency_type} - ${promo.frequency_value}\n`;
                        output += `   Horario: ${promo.start_time} - ${promo.end_time}\n`;
                        output += `   D√≠as: ${promo.days_of_week}\n`;
                        output += `   √öltima ejecuci√≥n: ${promo.last_executed || 'Nunca'}\n`;
                        output += `   Prioridad: ${promo.priority}\n\n`;
                    });
                    updateStatus('list-status', 'success');
                } else {
                    output += `‚ö†Ô∏è No hay promociones registradas.\n`;
                    updateStatus('list-status', 'warning');
                }

                showResult('list-result', output, data.promotions?.length > 0 ? 'success' : 'warning');
            } catch (error) {
                showResult('list-result', `‚ùå ERROR: ${error.message}`, 'error');
                updateStatus('list-status', 'error');
            }
        }

        async function testFrequency() {
            showResult('frequency-result', '‚è≥ Calculando frecuencia...', 'info');
            updateStatus('frequency-status', 'pending');

            try {
                const response = await fetch(`${BASE_URL}/api/admin/auto-promotions`);
                const data = await response.json();

                if (!data.promotions || data.promotions.length === 0) {
                    showResult('frequency-result', '‚ö†Ô∏è No hay promociones para calcular.', 'warning');
                    updateStatus('frequency-status', 'warning');
                    return;
                }

                const now = new Date();
                let output = `üïê Hora actual: ${now.toLocaleString('es-AR')}\n`;
                output += `üìÖ D√≠a actual: ${now.getDay()} (0=Dom, 1=Lun, 2=Mar, 3=Mi√©, 4=Jue, 5=Vie, 6=S√°b)\n\n`;

                data.promotions.forEach((promo, idx) => {
                    output += `${idx + 1}. ${promo.title} (${promo.is_active ? 'ACTIVA' : 'INACTIVA'})\n`;
                    
                    // Check frequency
                    let intervalMs = 0;
                    if (promo.frequency_type === 'hourly') {
                        intervalMs = (60 / promo.frequency_value) * 60 * 1000;
                    } else if (promo.frequency_type === 'daily') {
                        intervalMs = (24 * 60 / promo.frequency_value) * 60 * 1000;
                    } else if (promo.frequency_type === 'custom') {
                        intervalMs = promo.frequency_value * 60 * 1000;
                    }

                    output += `   Intervalo: ${intervalMs / 1000 / 60} minutos\n`;
                    
                    if (promo.last_executed) {
                        const lastExec = new Date(promo.last_executed);
                        const timeDiff = now - lastExec;
                        const minutesPassed = Math.floor(timeDiff / 1000 / 60);
                        output += `   √öltima ejecuci√≥n: ${lastExec.toLocaleString('es-AR')}\n`;
                        output += `   Tiempo desde √∫ltima: ${minutesPassed} minutos\n`;
                        output += `   ¬øDeber√≠a ejecutarse? ${timeDiff >= intervalMs ? '‚úÖ S√ç' : '‚ùå NO'}\n`;
                    } else {
                        output += `   √öltima ejecuci√≥n: Nunca\n`;
                        output += `   ¬øDeber√≠a ejecutarse? ‚úÖ S√ç (primera vez)\n`;
                    }
                    
                    output += `\n`;
                });

                showResult('frequency-result', output, 'success');
                updateStatus('frequency-status', 'success');
            } catch (error) {
                showResult('frequency-result', `‚ùå ERROR: ${error.message}`, 'error');
                updateStatus('frequency-status', 'error');
            }
        }

        async function resetLastExecuted() {
            const promoId = document.getElementById('promo-id').value.trim();
            
            if (!promoId) {
                showResult('reset-result', '‚ö†Ô∏è Por favor ingresa un ID de promoci√≥n.', 'warning');
                return;
            }

            showResult('reset-result', '‚è≥ Obteniendo datos de la promoci√≥n...', 'info');
            updateStatus('reset-status', 'pending');

            try {
                // Primero obtener la promoci√≥n actual
                const getResponse = await fetch(`${BASE_URL}/api/admin/auto-promotions`);
                const getData = await getResponse.json();
                
                const promo = getData.promotions?.find(p => p.id === promoId);
                
                if (!promo) {
                    showResult('reset-result', `‚ùå No se encontr√≥ una promoci√≥n con ID: ${promoId}`, 'error');
                    updateStatus('reset-status', 'error');
                    return;
                }

                // Actualizar con todos los campos + last_executed en null
                const response = await fetch(`${BASE_URL}/api/admin/auto-promotions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: promoId,
                        business_id: promo.business_id,
                        business_name: promo.business_name,
                        title: promo.title,
                        message: promo.message,
                        frequency_type: promo.frequency_type,
                        frequency_value: promo.frequency_value,
                        is_active: promo.is_active,
                        start_time: promo.start_time,
                        end_time: promo.end_time,
                        days_of_week: promo.days_of_week,
                        priority: promo.priority,
                        last_executed: null
                    })
                });

                const data = await response.json();

                if (data.success || response.ok) {
                    showResult('reset-result', `‚úÖ Last executed reseteado correctamente para "${promo.title}".\nLa promoci√≥n deber√≠a ejecutarse en la pr√≥xima verificaci√≥n.`, 'success');
                    updateStatus('reset-status', 'success');
                } else {
                    showResult('reset-result', `‚ùå Error: ${data.error || 'Error desconocido'}`, 'error');
                    updateStatus('reset-status', 'error');
                }
            } catch (error) {
                showResult('reset-result', `‚ùå ERROR: ${error.message}`, 'error');
                updateStatus('reset-status', 'error');
            }
        }

        async function runFullTest() {
            showResult('full-result', 'üöÄ Iniciando test completo...\n\n', 'info');
            updateStatus('full-status', 'pending');

            let fullOutput = 'üöÄ TEST COMPLETO DE AUTO-PROMOCIONES\n';
            fullOutput += '='.repeat(60) + '\n\n';

            try {
                // Test 1: List promotions
                fullOutput += 'üìã 1. LISTANDO PROMOCIONES\n';
                fullOutput += '-'.repeat(60) + '\n';
                const listResponse = await fetch(`${BASE_URL}/api/admin/auto-promotions`);
                const listData = await listResponse.json();
                fullOutput += `Total: ${listData.promotions?.length || 0} promociones\n`;
                if (listData.promotions && listData.promotions.length > 0) {
                    const activeCount = listData.promotions.filter(p => p.is_active).length;
                    fullOutput += `Activas: ${activeCount}\n`;
                    fullOutput += `Inactivas: ${listData.promotions.length - activeCount}\n`;
                }
                fullOutput += '\n';

                // Test 2: Scheduler
                fullOutput += '‚öôÔ∏è 2. TEST DE SCHEDULER\n';
                fullOutput += '-'.repeat(60) + '\n';
                const schedulerResponse = await fetch(`${BASE_URL}/api/admin/auto-promotions/scheduler`);
                const schedulerData = await schedulerResponse.json();
                fullOutput += `Promociones listas: ${schedulerData.count || 0}\n`;
                fullOutput += `Hora actual: ${schedulerData.current_time}\n`;
                fullOutput += `D√≠a actual: ${schedulerData.current_day}\n`;
                fullOutput += '\n';

                // Test 3: Auto-promotion API
                fullOutput += 'üéØ 3. TEST DE API AUTO-PROMOTION\n';
                fullOutput += '-'.repeat(60) + '\n';
                const apiResponse = await fetch(`${BASE_URL}/api/auto-promotion`);
                const apiData = await apiResponse.json();
                fullOutput += `Should show: ${apiData.shouldShow}\n`;
                if (apiData.shouldShow && apiData.promotion) {
                    fullOutput += `‚úÖ Promoci√≥n retornada: ${apiData.promotion.title}\n`;
                } else {
                    fullOutput += `‚ö†Ô∏è No hay promociones para mostrar ahora\n`;
                }
                fullOutput += '\n';

                // Diagnosis
                fullOutput += 'üîç DIAGN√ìSTICO\n';
                fullOutput += '-'.repeat(60) + '\n';
                
                if (listData.promotions?.length === 0) {
                    fullOutput += `‚ùå PROBLEMA: No hay promociones en la base de datos\n`;
                    fullOutput += `   SOLUCI√ìN: Ejecuta el INSERT SQL para crear una promoci√≥n\n`;
                } else if (listData.promotions?.filter(p => p.is_active).length === 0) {
                    fullOutput += `‚ùå PROBLEMA: No hay promociones activas\n`;
                    fullOutput += `   SOLUCI√ìN: Activa al menos una promoci√≥n desde el panel admin\n`;
                } else if (schedulerData.count === 0) {
                    fullOutput += `‚ö†Ô∏è PROBLEMA: Hay promociones activas pero ninguna cumple los criterios\n`;
                    fullOutput += `   POSIBLES CAUSAS:\n`;
                    fullOutput += `   - Horario configurado no coincide con la hora actual\n`;
                    fullOutput += `   - D√≠a de la semana no est√° en la configuraci√≥n\n`;
                    fullOutput += `   - La promoci√≥n se ejecut√≥ muy recientemente\n`;
                    fullOutput += `   SOLUCI√ìN: Revisa la configuraci√≥n de horarios y d√≠as\n`;
                } else if (!apiData.shouldShow) {
                    fullOutput += `‚ö†Ô∏è PROBLEMA: El scheduler encuentra promociones pero la API no las retorna\n`;
                    fullOutput += `   SOLUCI√ìN: Verifica el c√≥digo de /api/auto-promotion\n`;
                } else {
                    fullOutput += `‚úÖ TODO FUNCIONA CORRECTAMENTE\n`;
                    fullOutput += `   La promoci√≥n "${apiData.promotion.title}" est√° lista para ejecutarse\n`;
                    fullOutput += `   El ChatInterface deber√≠a mostrarla en el pr√≥ximo check (cada 2 min)\n`;
                }

                showResult('full-result', fullOutput, 'success');
                updateStatus('full-status', 'success');
            } catch (error) {
                fullOutput += `\n‚ùå ERROR DURANTE EL TEST: ${error.message}\n`;
                showResult('full-result', fullOutput, 'error');
                updateStatus('full-status', 'error');
            }
        }

        // Auto-load ID from URL parameter if present
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const promoId = urlParams.get('id');
            if (promoId) {
                document.getElementById('promo-id').value = promoId;
            }
        });
    </script>
</body>
</html>
